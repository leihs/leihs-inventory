<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Model</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.2/spark-md5.min.js"></script>
    <script>
        function generateLinks() {
            const poolId = document.getElementById('poolId').value;
            const modelId = document.getElementById('fetchModelId').value;

            const stagingLink = `https://staging.leihs.zhdk.ch/manage/${poolId}/models/${modelId}/edit?return_url=/manage/${poolId}/inventory`;
            const testLink = `https://test.leihs.zhdk.ch/manage/${poolId}/models/${modelId}/edit?return_url=/manage/${poolId}/inventory`;

            const stagingAdminLink = `https://staging.leihs.zhdk.ch/admin/users`;
            const testAdminLink = `https://test.leihs.zhdk.ch/admin/users`;

            document.getElementById('stagingLink').href = stagingLink;
            document.getElementById('stagingLink').innerText = "*/staging/manage/-Link to Edit";

            document.getElementById('testLink').href = testLink;
            document.getElementById('testLink').innerText = "*/test/manage/-Link to Edit";


            document.getElementById('stagingAdminLink').href = stagingAdminLink;
            document.getElementById('stagingAdminLink').innerText = "Staging-Admin";

            document.getElementById('testAdminLink').href = testAdminLink;
            document.getElementById('testAdminLink').innerText = "Test-Admin";
        }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <style>
        .limited-text {
            width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

        .links {
            padding: 0.5em 1em 1em 1em;
            margin-top: 1em;
            background-color: #f4f4f4;
            border-style: dashed;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input[type="text"], input[type="file"], textarea, select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }

        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        .myBtn {
            margin-top: 10px;
        }

        .btn-danger, .remove-file-btn, .deleteStyle {
            background-color: #dc3545;
        }

        .entitlement-row {
            display: flex;
            align-items: center;
            column-gap: 3rem;
            justify-content: space-around;
            margin-top: 0.5rem;
        }

        button:hover {
            background-color: #0056b3;
        }

        .dynamic-list {
            margin-top: 10px;
        }

        .dynamic-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .remove-btn {
            background-color: #dc3545;
        }

        .file-list {
            margin-top: 10px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        body.save-success {
            border: 1em solid #b8f4b8;
            transition: border 0.3s ease-in-out;
        }

        body.no-result-success {
            border: 1em solid #BFBFBF1C;
            transition: border 0.3s ease-in-out;
        }

        body.save-failed {
            border: 1em solid red;
            transition: border 0.3s ease-in-out;
        }

        #addAccessory, #addProperty {
            background-color: #dedede;
            color: black;
        }

        .image-group {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        .image-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 30%; /* Adjust as needed */
        }

        .image-container img {
            width: 100%;
            object-fit: cover;
        }

        .image-footer {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
    </style>


    <style>
        .image-container {
            position: relative;
            display: inline-block;
        }

        .image-container img {
            display: block;
            width: 100%;
            height: 100px;

        }

        .hover-text {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            opacity: 0.5; /* Always visible */
            pointer-events: none; /* Allows clicking through */
        }
    </style>

    <style>
        ul.dev-page-menu {
            list-style-type: none; /* Remove default bullets */
            padding: 0; /* Remove default padding */
            margin: 0; /* Remove default margin */
            display: flex; /* Display items in a row */
            justify-content: space-around; /* Space items evenly */
            background-color: #f4f4f4; /* Light gray background for the list */
            border: 1px solid #ddd; /* Add a border around the list */
            border-radius: 5px; /* Round the corners */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Add a subtle shadow */
        }

        ul li {
            margin: 0; /* Remove default margin */
        }

        ul.dev-page-menu li a {
            display: block;
            padding: 10px 15px; /* Add padding for better click area */
            text-decoration: none; /* Remove default underline */
            color: #333; /* Set text color */
            font-weight: 500; /* Make the font semi-bold */
            transition: background-color 0.3s, color 0.3s; /* Smooth hover effect */
            border-radius: 5px; /* Match border radius with the list */
        }

        ul.dev-page-menu li a:hover {
            background-color: #007BFF; /* Change background color on hover */
            color: white; /* Change text color on hover */
        }
    </style>
</head>
<body>
<ul class="dev-page-menu">
    <li><a target="_blank" href="/inventory/8bd16d45-056d-5590-bc7f-12849f034351/dev/upload">FileUpload</a></li>
    <li><a target="_blank" href="/inventory/8bd16d45-056d-5590-bc7f-12849f034351/dev/stable">InventoryList</a></li>
    <li><a target="_blank" href="/inventory/8bd16d45-056d-5590-bc7f-12849f034351/dev/model">Model</a></li>
    <li><a target="_blank" href="/inventory/8bd16d45-056d-5590-bc7f-12849f034351/dev/software">Software</a></li>
    <li><a target="_blank" href="/inventory/8bd16d45-056d-5590-bc7f-12849f034351/dev/license">License (d)</a></li>
    <li><a target="_blank" href="/inventory/8bd16d45-056d-5590-bc7f-12849f034351/dev/item">Item (d)</a></li>
    <li><a target="_blank" href="/inventory/8bd16d45-056d-5590-bc7f-12849f034351/dev/option">Option</a></li>
    <li><a target="_blank" href="/inventory/8bd16d45-056d-5590-bc7f-12849f034351/dev/package">Package (d)</a></li>
    <li><a target="_blank" href="/inventory/api-docs/index.html#/Auth/get_inventory_login">| Login</a></li>
    <li><a target="_blank" href="/inventory/api-docs/index.html#/Dev/get_inventory_dev_update_accounts">updateCreds</a>
    </li>
</ul>

<script>
    document.IMAGE_UUID = '0062c982-bd38-4fd4-840d-9f142023744e'

</script>
<h3>'Fetch image' Test</h3>

<div id="cache"></div>

<div class="image-group">
    <div class="image-container">
        <img src="/inventory/images/0062c982-bd38-4fd4-840d-9f142023744e/thumbnail" alt="Lights">
        <p class="image-footer">Thumbnail Image by img-Tag (API)<br/>/inventory/images/*/thumbnail</p>
    </div>
    <div class="image-container">
        <img src="/inventory/images/0062c982-bd38-4fd4-840d-9f142023744e" alt="Lights">
        <p class="image-footer">Image by img-Tag (API)<br/>/inventory/images/*</p>
    </div>
    <div class="image-container">
        <img id="testImage" alt="Lights">
        <p class="image-footer">Image by ajax-Request<br/>response to blob() with temporary URL</p>
    </div>
</div>

<br/><br/>
<br/><br/>


<div class="links">
    <h3>Links to Test/Staging <h5>(generated by Options-Attributes)</h5></h3>

    <div>
        <p><a id="testLink" href="#" target="_blank"></a></p>
        <p><a id="testAdminLink" href="https://test.leihs.zhdk.ch/admin/users" target="_blank">Test-Admin</a></p>
        <br/>
        <p><a id="stagingLink" href="#" target="_blank"></a></p>
        <p><a id="stagingAdminLink" href="https://staging.leihs.zhdk.ch/admin/users" target="_blank">Staging-Admin</a>
        </p>
    </div>
    <button class="myBtn" style="background-color: orange" onclick="generateLinks()">Generate Links</button>
</div>

<br/><br/>
<br/><br/>

<h1 id="formTitle">Create New Model</h1>

<h3>Options</h3>

<div class="form-group">
    <label for="poolId">Pool ID</label>
    <input type="text" id="poolId" name="poolId" value="8bd16d45-056d-5590-bc7f-12849f034351">
</div>
<div class="form-group">
    <label for="fetchModelId"><a target="_blank"
                                 href="/inventory/api-docs/index.html#/Models%20by%20pool/get_inventory__pool_id__models">Model-ID
        (API)</a></label>
    <input type="text" id="fetchModelId" name="fetchModelId" value="0467bf02-fab7-5bbc-b259-4d00f02ebbcf"/>
    <button id="fetchModelBtn" class="myBtn">Fetch model</button>
</div>

<br/><br/><br/><br/>

<form id="modelForm">
    <div class="form-group">
        <label for="product">Product *</label>
        <input type="text" id="product" name="product" required>
    </div>
    <div class="form-group">
        <label for="version">Version</label>
        <input type="text" id="version" name="version">
    </div>
    <div class="form-group">
        <label for="manufacturer">Manufacturer</label>
        <select id="manufacturer" name="manufacturer"></select>
    </div>
    <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" name="description"></textarea>
    </div>
    <div class="form-group">
        <label for="technicalDetail">Technical Details</label>
        <textarea id="technicalDetail" name="technical_detail"></textarea>
    </div>
    <div class="form-group">
        <label for="internalDescription">Internal Description</label>
        <textarea id="internalDescription" name="internal_description"></textarea>
    </div>
    <div class="form-group">
        <label for="handOverNote">Important notes for hand over</label>
        <textarea id="handOverNote" name="hand_over_note"></textarea>
    </div>
    <div class="form-group">
        <label>Eigenschaften</label>
        <div id="propertiesList" class="dynamic-list"></div>
        <button type="button" id="addProperty">Add Property</button>
    </div>
    <div class="form-group">
        <b><label for="images">Bilder</label></b>
        <input type="file" id="images" name="images" multiple accept="image/*">
        <input type="hidden" id="images-to-delete" name="images_to_delete"/>
        <div id="imagesList" class="file-list"></div>
    </div>
    <div class="form-group">
        <b><label for="attachments">Anhänge</label></b>
        <input type="file" id="attachments" name="attachments" multiple>
        <input type="hidden" id="attachments-to-delete" name="attachments_to_delete"/>
        <div id="attachmentsList" class="file-list"></div>
    </div>
    <div class="form-group">
        <label>
            <input type="checkbox" id="isPackage" name="is_package">
            This is a package
        </label>
    </div>

    <div class="form-group row">
        <label for="entitlements" class="col-sm-3 col-form-label">Zuteilungen (Anspruchsgruppen / Entitlements)</label>
        <div class="col-sm-9">
            <select id="entitlements" name="entitlements" class="form-control" multiple></select>
            <div id="selected-entitlements" class="mt-2"></div>
        </div>
    </div>

    <div class="form-group">
        <label for="categories">Kategorien ( /model-groups )</label>
        <select id="categories" name="categories" multiple></select>
    </div>
    <div class="form-group">
        <label for="compatibles">Ergänzende Modelle (Compatibles)</label>
        <select id="compatibles" name="compatibles" multiple></select>
    </div>
    <div class="form-group">
        <label>Zubehör</label>
        <div id="accessoriesList" class="dynamic-list"></div>
        <button type="button" id="addAccessory">Add Zubehör / Accessory</button>
    </div>
    <div class="form-group">
        <button type="submit" class="myBtn">Save Model</button>
        <button type="button" id="delete-model" class="myBtn deleteStyle">Delete Model</button>
    </div>
</form>

<script>
    $(document).ready(function () {

        var CONST_IS_CREATE_FORM = true;

        $('#delete-model').hide()
        $('#delete-model').click(function () {
            var modelId = $('#fetchModelId').val();
            var poolId = $('#poolId').val();

            $.ajax({
                url: '/inventory/' + poolId + '/model/' + modelId,
                method: 'DELETE',
                headers: {
                    'Accept': 'application/json'
                },
                success: function (response, textStatus, xhr) {
                    console.log('Model deleted successfully!', response);

                    $("#cache").removeData();

                    if (xhr.status === 200) {
                        $('body').addClass('save-success');
                        setTimeout(function () {
                            $('body').removeClass('save-success');
                        }, 3000);
                    } else {
                        $('body').addClass('save-failed');
                        setTimeout(function () {
                            $('body').removeClass('save-failed');
                        }, 3000);
                    }

                    $('#delete-model').hide();
                },
                error: function (xhr) {
                    console.error('Error deleting model:', xhr.responseText);

                    $('body').addClass('save-failed');
                    setTimeout(function () {
                        $('body').removeClass('save-failed');
                    }, 3000);
                }
            });
        })

        var FNC_CONFIG = (poolId, modelId) => {

            // create
            if (CONST_IS_CREATE_FORM) {
                return {
                    url: '/inventory/' + poolId + '/model/',
                    method: 'POST'
                }
            }

            // update
            return {
                url: '/inventory/' + poolId + '/model/' + modelId+"/",
                method: 'PUT'
            }
        };

        function initSelect2(selectId, type) {
            $(`#${selectId}`).select2({
                width: "100%",
                placeholder: "Select an option",
                allowClear: true
            });
        }

        function extractImageData() {
            let imagesData = [];
            let imagesToDelete = $('#images-to-delete').data('to-delete') || [];
            let fileItems = $('#imagesList .file-item');

            fileItems.each(function (index) {
                let fileId = $(this).find('.remove-file-btn').data('file-id');
                let isCover = $(this).find('input[name="is_cover"]').is(':checked');
                let hash = $(this).find('#hash').html()
                let toDelete = imagesToDelete.includes(fileId);

                var data = {
                    id: fileId,
                    is_cover: isCover,
                    to_delete: toDelete
                }
                imagesData.push(data);
            });

            imagesToDelete.forEach(fileId => {
                imagesData.push({
                    id: fileId,
                    is_cover: false,
                    to_delete: true
                });
            });
            return imagesData;
        }

        function updateSelectedEntitlements() {
            const selectedContainer = $('#selected-entitlements');
            selectedContainer.empty();

            $('#entitlements option:selected').each(function () {
                const entitlement = $(this).data('entitlement_group');

                if (entitlement == undefined) {
                    return;
                }

                const data = $('#entitlements').data('entitlement-groups')
                let matchingEntry;
                if (data == undefined) {
                    matchingEntry = {quantity: 1}
                } else {
                    matchingEntry = data.find(entry => entry.group_id === entitlement.id) || {quantity: 1};
                }


                const entitlementElement = $('<div class="selected-item entitlement-row mb-2" style_="display:flex; align-items: center; column-gap: 3rem;">')
                    .text(entitlement.name)
                    .append(
                        $('<input>', {
                            type: 'number',
                            class: 'form-control form-control-sm d-inline-block ml-2',
                            style: 'width: 60px;',
                            uuid: entitlement.id
                            // }).val(1)
                        }).val(matchingEntry.quantity)
                    )
                    .append(
                        $('<button class="btn btn-sm btn-danger ml-2">Remove</button>')
                            .on('click', function () {
                                $(this).parent().remove();
                                $('#entitlements option[value="' + entitlement.id + '"]').prop('selected', false);
                                $('#entitlements').trigger('change');
                            })
                    );
                selectedContainer.append(entitlementElement);
            });
        }

        // Handle selection of entitlements
        $('#entitlements').on('change', function () {
            updateSelectedEntitlements();
        });

        // let previousSelection = [];
        function fetchOptions(url, selectId) {
            fetch(url, {headers: {'Accept': 'application/json'}})
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Select an option</option>';

                    data.forEach(item => {
                        var option = document.createElement('option');

                        // Handle `manufacturer`
                        if (selectId === 'manufacturer') {
                            option.value = item;
                            option.textContent = item;
                            $(option).data('manufacturer', item);
                            select.appendChild(option);
                            return;
                        }

                        // Handle `compatibles`
                        if (selectId === 'compatibles') {
                            option.value = item.model_id;
                            option.textContent = item.product;
                            $(option).data('compatible', item);
                            select.appendChild(option);


                            return;
                        }

                        // Handle `entitlements`
                        if (selectId === 'entitlements') {
                            option.value = item.id;
                            option.textContent = item.name;
                            $(option).data('entitlement_group', item);
                            select.appendChild(option);


                            return;
                        }

                        // Default case for other `selectId`
                        option.value = item.id;
                        option.textContent = item.name;

                        if (selectId === 'categories') {
                            $(option).data('categories', item);
                        }

                        select.appendChild(option);

                        console.log('>>> category-option / ' + selectId, option);


                    });

                    console.log(">>> INIT SELECT2 / " + selectId)
                    initSelect2(selectId);

                    if (selectId === 'entitlements') {
                        $("#cache").data(`prev-${selectId}`, $('#entitlements').val());
                    }

                    if (selectId === 'compatibles') {
                        $("#cache").data(`prev-${selectId}`, $('#compatibles').val());
                    }

                    if (selectId === 'categories') {
                        $("#cache").data(`prev-${selectId}`, $('#categories').val());
                    }


                })
                .catch(error => console.error('Error:', error));
        }

        function renameKeys(obj, keyMap) {
            return Object.fromEntries(
                Object.entries(obj).map(([key, value]) => [
                    keyMap[key] || key, // Use the new key if specified in keyMap; otherwise, keep the original key
                    value,
                ])
            );
        }

        function updateDropdowns(poolId) {
            fetchOptions(`/inventory/manufacturers`, 'manufacturer');
            fetchOptions(`/inventory/${poolId}/entitlement-groups`, 'entitlements');
            fetchOptions(`/inventory/models-compatibles`, 'compatibles');
            fetchOptions(`/inventory/${poolId}/model-groups`, 'categories');
        }

        // Initialize dropdowns on page load
        var initialPoolId = $('#poolId').val();
        updateDropdowns(initialPoolId);

        $('#fetchModelBtn').click(function () {
            var modelId = $('#fetchModelId').val();
            var poolId = $('#poolId').val();

            $('#delete-model').show()

            // Send request to API
            $.ajax({
                url: '/inventory/' + poolId + '/model/' + modelId,
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                },
                success: function (response) {
                    console.log('Model fetched successfully!');
                    console.log(response);

                    $("#cache").removeData();

                    response = response[0];

                    if (response == undefined) {
                        $('body').addClass('no-result-success');
                        setTimeout(function () {
                            $('body').removeClass('no-result-success');
                        }, 3000);

                        return
                    }

                    // Fill form with response data
                    $('#product').val(response.product);
                    $('#version').val(response.version);
                    $('#manufacturer').val(response.manufacturer).trigger('change');
                    $('#description').val(response.description);
                    $('#technicalDetail').val(response.technical_detail);
                    $('#internalDescription').val(response.internal_description);
                    $('#handOverNote').val(response.hand_over_note);
                    // $('#isPackage').prop('checked', response.type === 'Package');
                    // formData.delete('isPackage');
                    $('#isPackage').prop('checked', response.is_package);

                    // Set CONST_IS_CREATE_FORM to false and update the title
                    CONST_IS_CREATE_FORM = false;
                    $('#formTitle').text('Update Model');

                    // Populate properties
                    $('#propertiesList').empty();
                    response.properties.forEach(function (prop) {
                        var ab = $('#propertiesList').append(`
                            <div class="dynamic-item">
                                <input type="text" type="key" id="${prop.id}" name="propertyKey[]" value="${prop.key}" required>
                                <input type="text" type="value" id="${prop.id}" name="propertyValue[]" value="${prop.value}" required>
                                <button type="button"  ftype="properties" class="remove-btn">Remove</button>
                            </div>
                        `);
                    });

                    // Populate accessories
                    $('#accessoriesList').empty();
                    response.accessories.forEach(function (acc) {
                        $('#accessoriesList').append(`
                            <div class="dynamic-item">
                                <input type="text"   id="${acc.id}" name="accessoryName[]" value="${acc.name}" required>
                                <label>
                                    <input type="checkbox"  id="${acc.id}" name="accessoryInventory[]" ${acc.has_inventory_pool === true ? 'checked' : ''}>
                                    In inventory
                                </label>
                                <button type="button" ftype="accessories" class="remove-btn">Remove</button>
                            </div>
                        `);
                    });

                    function cacheDeletedProperties(type, obj) {
                        var data = $("#cache").data(`deleted-${type}`) || []
                        const key = obj.siblings('input[name="propertyKey[]"]').val();
                        const val = obj.siblings('input[name="propertyValue[]"]').val();

                        data.push({
                            id: $(this).prev().attr("id"),
                            delete: true,
                            key: key,
                            value: val
                        })
                        return data
                    }

                    function cacheDeletedAccessories(type, obj) {
                        const data = $("#cache").data(`deleted-${type}`) || []
                        data.push({
                            id: obj.siblings('input[name="accessoryName[]"]').attr('id'),
                            delete: true,
                            name: obj.siblings('input[name="accessoryName[]"]').val(),
                            is_inventory: obj.closest('.dynamic-item').find('input[name="accessoryInventory[]"]').val() == 'on'
                        })
                        return data
                    }


                    // Add event listener for remove button to delete only the clicked item
                    $(document).on('click', '.remove-btn', function () {
                        const type = $(this).attr("ftype")
                        var data = [];
                        console.log(">o> remove-btn > !!!!", type)
                        if (type === 'properties') {
                            data = cacheDeletedProperties(type, $(this))
                        } else if (type === 'accessories') {
                            data = cacheDeletedAccessories(type, $(this))
                        } else {
                            console.log(">o> NOT YET IMPLEMENTED >> remove-btn >> ", type, data)
                        }

                        console.log(">o> remove-btn > ", type, data)
                        $("#cache").data(`deleted-${type}`, data)

                        $(this).closest('.dynamic-item').remove();
                    });


                    // Populate entitlements (entitlement groups)
                    $('#entitlements').data('entitlement-groups', response.entitlement_groups)
                    $('#entitlements').val(response.entitlement_groups.map(eg => eg.group_id)).trigger('change');
                    $('#entitlements').find('option:selected').each(function (index, option, a, b) {
                        const groupId = $(option).val();
                        const entitlementData = response.entitlement_groups.find(eg => eg.group_id === groupId);
                        if (entitlementData) {
                            $(option).data('entitlement', entitlementData);
                            console.log('Updated option data:', $(option).data('entitlement'));
                        }
                    });
                    $('#entitlements').on('change', function () {
                        const currentSelection = $(this).val() || [];
                        const previousSelection = $("#cache").data("prev-entitlements") || [];
                        const removedOptions = previousSelection.filter(id => !currentSelection.includes(id));

                        var deleted_data = $("#cache").data("deleted-entitlements") || []
                        removedOptions.forEach(id => {
                            const removedOption = $(this).find(`option[value="${id}"]`);
                            var removedEntitlementData = removedOption.data('entitlement')
                            if (removedEntitlementData == undefined) {
                                return;
                            }

                            removedEntitlementData.delete = true;

                            console.log('Removed option data:', removedEntitlementData);
                            var keyMapa = {id: "entitlement_id", group_id: "entitlement_group_id"};
                            removedEntitlementData = renameKeys(removedEntitlementData, keyMapa);
                            deleted_data.push(removedEntitlementData)
                        });

                        $("#cache").data("deleted-entitlements", deleted_data);
                        // $("#cache").data("deleted-categories",  deleted_data);

                        $("#cache").data("prev-entitlements", currentSelection);
                    });


                    // Populate categories (assuming it's part of the response)
                    if (response.categories) {
                        $('#categories').val(response.categories.map(c => c.id)).trigger('change');
                        $('#categories').find('option:selected').each(function (index, option, a, b) {
                            const categoryId = $(option).val();
                            const entitlementData = response.categories.find(eg => eg.id === categoryId);
                            if (entitlementData) {
                                $(option).data('categories', entitlementData);
                                console.log('Updated option data:', $(option).data('categories'));
                            }
                        });
                        $("#cache").data("prev-categories", $('#categories').val())

                        $('#categories').on('change', function () {
                            const currentSelection = $(this).val() || [];
                            const previousSelection = $("#cache").data("prev-categories") || [];
                            const removedOptions = previousSelection.filter(id => !currentSelection.includes(id));

                            var deleted_data = $("#cache").data("deleted-categories") || []
                            removedOptions.forEach(id => {
                                const removedOption = $(this).find(`option[value="${id}"]`);
                                var removedEntitlementData = removedOption.data('categories')
                                if (removedEntitlementData == undefined) {
                                    return;
                                }

                                removedEntitlementData.delete = true;
                                deleted_data.push(removedEntitlementData)
                            });

                            $("#cache").data("deleted-categories", deleted_data);
                            $("#cache").data("prev-categories", currentSelection);
                        });
                    }

                    if (response.compatibles) {


                        // Populate compatibles
                        $('#compatibles').val(response.compatibles
                            .filter(c => c && c.id != null)
                            .map(c => c.id)).trigger('change');

                        $('#compatibles').find('option:selected').each(function (index, option, a, b) {
                            const categoryId = $(option).val();
                            var entitlementData = response.compatibles.find(eg => eg.id === categoryId);
                            if (entitlementData) {
                                $(option).data('compatible', entitlementData);
                                console.log('Updated option data:', $(option).data('compatible'));
                            }
                        });
                        $("#cache").data("prev-compatibles", $('#compatibles').val())

                        $('#compatibles').on('change', function () {
                            const currentSelection = $(this).val() || [];
                            const previousSelection = $("#cache").data("prev-compatibles") || [];
                            const removedOptions = previousSelection.filter(id => !currentSelection.includes(id));

                            var deleted_data = $("#cache").data("deleted-compatibles") || []
                            removedOptions.forEach(id => {
                                const removedOption = $(this).find(`option[value="${id}"]`);
                                var removedEntitlementData = removedOption.data('compatible')
                                if (removedEntitlementData == undefined) {
                                    return;
                                }

                                removedEntitlementData.delete = true;
                                deleted_data.push(removedEntitlementData)
                            });

                            $("#cache").data("deleted-compatibles", deleted_data);
                            $("#cache").data("prev-compatibles", currentSelection);
                        });
                    }
                    ;

                    // Populate existing images
                    $('#imagesList').empty();
                    response.image_attributes.forEach(function (image, index) {
                        $('#imagesList').append(`
                            <div class="file-item">
                                <div class="image-container">
                                    <a href="${image["thumbnail_url"]}" target="_blank">
                                        <img src="${image["thumbnail_url"]}" alt="Thumbnail" />
                                        <div class="hover-text">thumbnail</div>
                                    </a>
                                </div>
                                <div class="image-container">
                                    <a href="${image["url"]}" target="_blank">
                                        <img src="${image["url"]}" alt="Original"/>
                                        <div class="hover-text">original</div>
                                    </a>
                                </div>
                                <p>${image["filename"]}</p>
                                <input type="radio" name="is_cover" value="${image.id}" ${image.is_cover === true ? 'checked' : ''}>
                                <button type="button" ftype="images" class="remove-file-btn" data-file-id="${image.id}" data-file-index="${index}">Remove</button>
                            </div>
                        `);
                    });

                    // Populate existing attachments
                    $('#attachmentsList').empty();
                    response.attachments.forEach(function (attachment, index) {
                        $('#attachmentsList').append(`
                            <div class="file-item">
                                <a href="/inventory/attachments/${attachment["id"]}" target="_blank">${attachment.filename}</a>
                                <button type="button" ftype="attachments"  class="remove-file-btn" data-file-id="${attachment.id}" data-file-index="${index}">Remove</button>
                            </div>
                        `);
                    });

                    $('body').addClass('save-success');
                    setTimeout(function () {
                        $('body').removeClass('save-success');
                    }, 3000);
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching model: ' + error);
                    $('body').addClass('save-failed');
                    setTimeout(function () {
                        $('body').removeClass('save-failed');
                    }, 3000);
                }
            });
        });


        $('#testImage').ready(function () {
            // alert('fetchModelBtn');

            var modelId = $('#fetchModelId').val();
            var poolId = $('#poolId').val();

            fetch("/inventory/images/0062c982-bd38-4fd4-840d-9f142023744e/thumbnail", {
                headers: {
                    "Accept": "image/jpeg" // This specifies that you’re expecting an image in response
                }
            })
                .then(response => {
                    if (response.ok) {
                        console.log("create blob()")
                        return response.blob(); // Convert the response to a blob
                    }
                    throw new Error('Network response was not ok.');
                })
                .then(blob => {
                    console.log("todo: imgUrl create")
                    const imgUrl = URL.createObjectURL(blob);
                    document.getElementById('testImage').src = imgUrl; // Assumes you have an <img id="myImage">
                    console.log("imgUrl created")
                })
                .catch(error => {
                    console.error('There has been a problem with your fetch operation:', error);
                });

        });


        // Add Property
        $('#addProperty').click(function () {
            $('#propertiesList').append(`
                <div class="dynamic-item">
                    <input type="text" name="propertyKey[]" placeholder="Key" required>
                    <input type="text" name="propertyValue[]" placeholder="Value" required>
                    <button type="button" class="remove-btn">Remove</button>
                </div>
            `);


        });

        // Add Accessory
        $('#addAccessory').click(function () {
            $('#accessoriesList').append(`
                <div class="dynamic-item">
                    <input type="text" name="accessoryName[]" placeholder="Accessory name" required>
                    <label>
                        <input type="checkbox" name="accessoryInventory[]">
                        In inventory
                    </label>
                    <button type="button" class="remove-btn">Remove</button>
                </div>
            `);
        });

        // Remove dynamic item
        $(document).on('click', '.remove-btn', function () {
            $(this).parent().remove();
        });

        // Handle file selection for images
        $('#images').change(function () {
            updateFileList(this, '#imagesList', 'images');
        });

        // Handle file selection for attachments
        $('#attachments').change(function () {
            updateFileList(this, '#attachmentsList', 'attachments');
        });

        // Update file list
        function addPostfixToFilename(filename, postfix) {
            const dotIndex = filename.lastIndexOf('.');

            if (dotIndex === -1) {
                return filename + postfix;
            }

            const name = filename.substring(0, dotIndex);
            const extension = filename.substring(dotIndex);

            return name + postfix + extension;
        }

        // Generates attachment/image-entries for html-list
        function updateFileList(input, listSelector, inputId) {
            var fileList = $(listSelector);
            console.log(">> updateFileList1 > ", input.files);
            console.log(">> updateFileList2 > ", listSelector);

            if (input.files && input.files.length > 0) {
                for (var i = 0, image_id = 1; i < input.files.length; i++, image_id++) {
                    let file = input.files[i];
                    let fileName = file.name;
                    let fileNameThumb = addPostfixToFilename(fileName, "_thumb");
                    file.nameThumb = fileNameThumb;

                    // Create a file item container
                    let fileItem;
                    if (listSelector === "#imagesList") {
                        fileItem = $(`
                    <div class="file-item">
                        <span>${fileName}</span>
                        <button type="button" ftpye="${inputId}" image_id="${image_id}" class="remove-file-btn" data-file-index="${i}">Remove</button>
                        <input type="radio" name="is_cover" image_id="${image_id}">
                        <canvas id="canvas-${inputId}-${i}" image_id="${image_id}" fileName="${fileNameThumb}" width="100" height="100" style="border: 1px solid #000; display: none;"></canvas>
                    </div>
                `);
                    } else {
                        fileItem = $(`
                    <div class="file-item">
                        <span>${fileName}</span>
                        <button type="button" ftpye="${inputId}" class="remove-file-btn" data-file-index="${i}">Remove</button>
                        <canvas id="canvas-${inputId}-${i}" fileName="${fileNameThumb}" width="100" height="100" style="border: 1px solid #000; display: none;"></canvas>
                    </div>
                `);
                    }

                    fileList.append(fileItem);
                    fileItem.find("canvas").data("file", file)

                    if (file.type.startsWith('image/')) {
                        var reader = new FileReader();

                        reader.onload = (function (canvasId) {
                            return function (e) {
                                var canvas = document.getElementById(canvasId);
                                var ctx = canvas.getContext('2d');
                                var img = new Image();

                                img.onload = function () {
                                    // Resize and draw the image to fit the canvas
                                    var aspectRatio = img.width / img.height;
                                    var canvasWidth = canvas.width;
                                    var canvasHeight = canvas.height;

                                    if (aspectRatio > 1) {
                                        canvasHeight = canvas.width / aspectRatio;
                                    } else {
                                        canvasWidth = canvas.height * aspectRatio;
                                    }

                                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                                    ctx.drawImage(img, 0, 0, canvasWidth, canvasHeight);

                                    $(canvas).show();
                                };

                                img.src = e.target.result;
                            };
                        })(`canvas-${inputId}-${i}`);

                        reader.readAsDataURL(file);
                    }
                }
            }
        }

        // Remove file from list
        $(document).on('click', '.remove-file-btn', function () {
            var fileId = $(this).data('fileId')
            var inputId = $(this).closest('.file-list').attr('id') === 'imagesList' ? 'images' : 'attachments';

            var toDelte = $(`#${inputId}-to-delete`).data('to-delete') || []
            toDelte.push(fileId)
            $(`#${inputId}-to-delete`).data('to-delete', toDelte)

            $(this).parent().remove();

        });

        // Remove file from input
        function removeFile(inputId, index) {
            var input = document.getElementById(inputId);
            var files = Array.from(input.files);
            files.splice(index, 1);

            // Create a new FileList object
            var dataTransfer = new DataTransfer();
            files.forEach(file => {
                dataTransfer.items.add(file);
            });
            input.files = dataTransfer.files;

            // Update the file list display
            updateFileList(input, `#${inputId}List`, inputId);
        }

        // Clear form fields
        function clearForm() {
            $('#modelForm')[0].reset();
            $('#propertiesList').empty();
            $('#accessoriesList').empty();
            $('#imagesList').empty();
            $('#attachmentsList').empty();
            $('#images-to-delete').empty();
            $('#attachments-to-delete').empty();
            $('select').val(null).trigger('change');
        }

        // Form submission
        $('#modelForm').submit(function (e) {
            e.preventDefault();

            var payload = {
                product: $('#product').val(),
                version: $('#version').val(),
                manufacturer: $('#manufacturer').val(),
                description: $('#description').val(),
                technical_detail: $('#technicalDetail').val(),
                internal_description: $('#internalDescription').val(),
                hand_over_note: $('#handOverNote').val(),
                is_package: $('#isPackage').is(':checked'),
                properties: [],
                accessories: [],
                entitlements: [],
                categories: [],
                compatibles: [],
                image_attributes: extractImageData(), // still ok since it's metadata
                attachments_to_delete: $(`#attachments-to-delete`).data('to-delete') || []
            };

            $('input[name="propertyKey[]"]').each(function (index) {
                payload.properties.push({
                    key: $(this).val(),
                    value: $('input[name="propertyValue[]"]').eq(index).val(),
                    id: $('input[name="propertyValue[]"]').eq(index).attr('id')
                });
            });

            const deletedProps = $("#cache").data("deleted-properties") || [];
            payload.properties = payload.properties.concat(deletedProps);

            // Prepare accessories
            var accessories = [];
            $('input[name="accessoryName[]"]').each(function (index, option) {

                if (option.textContent === 'Select an option') {
                    return;
                }

                accessories.push({
                    name: $(this).val(),
                    inventory_bool: $('input[name="accessoryInventory[]"]').eq(index).is(':checked'),
                    id: $('input[name="accessoryInventory[]"]').eq(index).attr('id')
                });
            });
            deleted_data = $("#cache").data("deleted-accessories") || []
            mergedProperties = accessories.concat(deleted_data);
            console.log(">o> accessories > ", mergedProperties)
            payload.accessories = mergedProperties;

            // Prepare entitlements
            const entitlements = [];
            $('#entitlements').find('option:selected').each(function (index, option) {
                if (option.textContent === 'Select an option') {
                    return;
                }

                const entitlementData = $(option).data()
                const entitlement = entitlementData.entitlement
                const entitlement_group = entitlementData.entitlement_group

                const entitlement_group_id = entitlementData.entitlement_group.id


                var quantity = parseInt($("#selected-entitlements").find("input[uuid=" + entitlement_group_id + "]").val(), 10)
                if (isNaN(quantity)) {
                    console.error("Quantity is not a number, setting to 1")
                    quantity = 1
                }

                if (entitlementData) {
                    entitlements.push({
                        entitlement_group_id: entitlement_group.id,
                        entitlement_id: entitlement == undefined ? null : entitlement.id,
                        // quantity: entitlement == undefined ? 1 : (quantity || 1)
                        quantity: (quantity || 1)
                    });
                }
            });
            deleted_data = $("#cache").data("deleted-entitlements") || []
            mergedProperties = entitlements.concat(deleted_data);
            console.log(">o> entitlements > ", mergedProperties)
            payload.entitlements = mergedProperties;

            // Prepare categories
            const categories = [];
            $('#categories').find('option:selected').each(function (index, option) {
                if (option.textContent === 'Select an option') {
                    return;
                }

                const categoriesData = $(option).data().categories
                if (categoriesData) {
                    categories.push(categoriesData)
                }
            });
            deleted_data = $("#cache").data("deleted-categories") || []
            mergedProperties = categories.concat(deleted_data);
            console.log(">o> categories > ", mergedProperties)
            payload.categories = mergedProperties;


            // Prepare compatibles
            const compatibles = [];
            $('#compatibles').find('option:selected').each(function (index, option) {
                if (option.textContent === 'Select an option') {
                    return;
                }

                const categoriesData = $(option).data().compatible
                if (categoriesData) {
                    compatibles.push(categoriesData)
                }
            });
            deleted_data = $("#cache").data("deleted-compatibles") || []
            mergedProperties = compatibles.concat(deleted_data);

            console.log(">o> compatibles 1> ", mergedProperties)

            var keyMapa = {model_id: "id"};
            mergedProperties.forEach(function (item, index) {
                mergedProperties[index] = renameKeys(item, keyMapa);
            });

            console.log(">o> compatibles 2> ", mergedProperties)
            payload.compatibles = mergedProperties;

            const poolId = $('#poolId').val();
            const modelId = $('#fetchModelId').val();
            const config = FNC_CONFIG(poolId, modelId);

            $.ajax({
                url: config.url,
                method: config.method,
                contentType: 'application/json',
                data: JSON.stringify(payload),
                headers: {
                    'Accept': 'application/json'
                },
                success: function (response) {
                    console.log('Model saved successfully:', response);
                    clearForm();
                    $("#cache").removeData();

                    if (CONST_IS_CREATE_FORM) {
                        $('#fetchModelId').val(response.data?.id || '');
                        $('#delete-model').hide();
                    } else {
                        $('#fetchModelId').val(response[0]?.id || '');
                        $('#fetchModelBtn').click();
                        $('#delete-model').show();
                    }

                    $('body').addClass('save-success');
                    setTimeout(() => $('body').removeClass('save-success'), 3000);
                },
                error: function (xhr) {
                    console.error('Error saving model:', xhr.responseText);
                    $('body').addClass('save-failed');
                    setTimeout(() => $('body').removeClass('save-failed'), 3000);
                }
            });
        });

        // Extract params from URL
        const urlParams = new URLSearchParams(window.location.search);

        const poolIdParam = urlParams.get('pool_id');
        const modelIdParam = urlParams.get('model_id');

        // Conditionally set input fields
        if (poolIdParam) {
            document.getElementById('poolId').value = poolIdParam;
        }

        if (modelIdParam) {
            document.getElementById('fetchModelId').value = modelIdParam;
        }

        if (modelIdParam && poolIdParam) {
            $("#fetchModelBtn").click()
        }
    });
</script>
</body>
</html>