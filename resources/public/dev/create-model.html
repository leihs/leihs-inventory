<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Model</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input[type="text"], input[type="file"], textarea, select { width: 100%; padding: 8px; box-sizing: border-box; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .dynamic-list { margin-top: 10px; }
        .dynamic-item { display: flex; gap: 10px; margin-bottom: 10px; }
        .remove-btn { background-color: #dc3545; }
        .file-list { margin-top: 10px; }
        .file-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        body.save-success {
            border: 1em solid #b8f4b8;
            transition: border 0.3s ease-in-out;
        }
        body.save-failed {
            border: 1em solid red;
            transition: border 0.3s ease-in-out;
        }
        #addAccessory, #addProperty { background-color: #dedede; color: black;        }
        .image-group {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        .image-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 30%; /* Adjust as needed */
        }

        .image-container img {
            width: 100%;
            object-fit: cover;
        }

        .image-footer {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

    </style>
</head>
<body>

<h3>'Fetch image' Test</h3>

<div class="image-group">
    <div class="image-container">
        <img src="http://localhost:3260/inventory/images/fe8e42a0-1d31-4449-8c91-24c17ddd5d10/thumbnail" alt="Lights">
        <p class="image-footer">Thumbnail Image by img-Tag</p>
    </div>
    <div class="image-container">
        <img src="http://localhost:3260/inventory/images/fe8e42a0-1d31-4449-8c91-24c17ddd5d10" alt="Lights">
        <p class="image-footer">Image by img-Tag</p>
    </div>
    <div class="image-container">
        <img id="testImage" alt="Lights">
        <p class="image-footer">Image  by ajax-Request</p>
    </div>
</div>

<br/><br/><br/><br/>

<h3>Options</h3>

<div class="form-group">
    <label for="poolId">Pool ID</label>
    <input type="text" id="poolId" name="poolId" value="8bd16d45-056d-5590-bc7f-12849f034351">
</div>
<div class="form-group">
    <label for="fetchModelId">Model-ID</label>
    <input type="text" id="fetchModelId" name="fetchModelId" value="5f5872b7-e40b-49b8-b6fa-a7eea0d3bbef"/>
    <input type="button" id="fetchModelBtn" value="Fetch model" class="btn" />
</div>

<br/><br/><br/><br/>

<h1 id="formTitle">Create New Model</h1>

<form id="modelForm">
    <div class="form-group">
        <label for="product">Product *</label>
        <input type="text" id="product" name="product" required>
    </div>
    <div class="form-group">
        <label for="version">Version</label>
        <input type="text" id="version" name="version">
    </div>
    <div class="form-group">
        <label for="manufacturer">Manufacturer</label>
        <select id="manufacturer" name="manufacturer"></select>
    </div>
    <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" name="description"></textarea>
    </div>
    <div class="form-group">
        <label for="technicalDetails">Technical Details</label>
        <textarea id="technicalDetails" name="technicalDetails"></textarea>
    </div>
    <div class="form-group">
        <label for="internalDescription">Internal Description</label>
        <textarea id="internalDescription" name="internalDescription"></textarea>
    </div>
    <div class="form-group">
        <label>Eigenschaften</label>
        <div id="propertiesList" class="dynamic-list"></div>
        <button type="button" id="addProperty">Add Property</button>
    </div>
    <div class="form-group">
        <label for="images">Bilder</label>
        <input type="file" id="images" name="images" multiple accept="image/*">
        <div id="imagesList" class="file-list"></div>
    </div>
    <div class="form-group">
        <label for="attachments">Anhänge</label>
        <input type="file" id="attachments" name="attachments" multiple>
        <div id="attachmentsList" class="file-list"></div>
    </div>
    <div class="form-group">
        <label>
            <input type="checkbox" id="isPackage" name="isPackage">
            This is a package
        </label>
    </div>
    <div class="form-group">
        <label for="allocations">Zuteilungen (Anspruchsgruppen / Entitlements)</label>
        <select id="allocations" name="allocations" multiple></select>
    </div>
    <div class="form-group">
        <label for="categories">Kategorien</label>
        <select id="categories" name="categories" multiple></select>
    </div>
    <div class="form-group">
        <label for="compatibles">Ergänzende Modelle (Compatibles)</label>
        <select id="compatibles" name="compatibles" multiple></select>
    </div>
    <div class="form-group">
        <label>Zubehör</label>
        <div id="accessoriesList" class="dynamic-list"></div>
        <button type="button" id="addAccessory">Add Zubehör / Accessory</button>
    </div>
    <div class="form-group">
        <button type="submit">Save Model</button>
    </div>
</form>

<script>
    $(document).ready(function() {

        var CONST_IS_CREATE_FORM = true;

        var FNC_CONFIG = (poolId, modelId) => {

            // create
            if(CONST_IS_CREATE_FORM) {
                return  {
                        url: 'http://localhost:3260/inventory/' + poolId + '/model',
                        method: 'POST'
                    }
                }

            // update
            return  {
                    url:  'http://localhost:3260/inventory/' + poolId + '/model/' + modelId,
                    method: 'PUT'
                }
        };

        // var CONST_CONFIG = {
        //     create: {
        //         url: function(poolId) { return 'http://localhost:3260/inventory/' + poolId + '/model'; },
        //         method: 'POST'
        //     },
        //     update: {
        //         url: function(poolId, modelId) { return 'http://localhost:3260/inventory/' + poolId + '/model/' + modelId; },
        //         method: 'PUT'
        //     }
        // };
        function fetchOptions(url, selectId) {
            fetch(url, {headers: {'Accept': 'application/json'}})
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Select an option</option>';

                    if (selectId === 'compatibles') {
                        data = data.data;
                    }

                    data.forEach(item => {
                        const option = document.createElement('option');

                        if (selectId === 'manufacturer') {
                            option.value = item;
                            option.textContent = item;
                            select.appendChild(option);
                            return;
                        }

                        if (selectId === 'compatibles') {
                            option.value = item.model_id;
                            option.textContent = item.product;
                            select.appendChild(option);
                            return;
                        }

                        option.value = item.id;
                        option.textContent = item.name;
                        select.appendChild(option);
                    });

                    // Initialize Select2 for dropdowns
                    $(`#${selectId}`).select2({
                        width: '100%',
                        placeholder: 'Select an option',
                        allowClear: true
                    });
                })
                .catch(error => console.error('Error:', error));
        }

        function updateDropdowns(poolId) {
            fetchOptions(`http://localhost:3260/inventory/manufacturers`, 'manufacturer');
            fetchOptions(`http://localhost:3260/inventory/${poolId}/entitlement-groups`, 'allocations');
            fetchOptions(`http://localhost:3260/inventory/${poolId}/model-groups`, 'categories');
            fetchOptions(`http://localhost:3260/inventory/models-compatibles`, 'compatibles');
        }

        // Initialize dropdowns on page load
        var initialPoolId = $('#poolId').val();
        updateDropdowns(initialPoolId);

        // Update dropdowns when pool ID changes
        // $('#poolId').change(function() {
        //     var newPoolId = $(this).val();
        //     updateDropdowns(newPoolId);
        // });

        $('#fetchModelBtn').click(function() {
            var modelId = $('#fetchModelId').val();
            var poolId = $('#poolId').val();

            // Send request to API
            $.ajax({
                url: 'http://localhost:3260/inventory/' + poolId + '/model/' + modelId,
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                },
                success: function(response) {
                    console.log('Model fetched successfully!');
                    console.log(response);

                    response= response[0];

                    // Fill form with response data
                    $('#product').val(response.product);
                    $('#version').val(response.version);
                    $('#manufacturer').val(response.manufacturer).trigger('change');
                    $('#description').val(response.description);
                    $('#technicalDetails').val(response.technical_detail);
                    $('#internalDescription').val(response.internal_description);
                    $('#isPackage').prop('checked', response.type === 'Package');

                    // Set CONST_IS_CREATE_FORM to false and update the title
                    CONST_IS_CREATE_FORM = false;
                    $('#formTitle').text('Update Model');

// Populate properties
                    $('#propertiesList').empty();
                    response.properties.forEach(function(prop) {
                        $('#propertiesList').append(`
                        <div class="dynamic-item">
                            <input type="text" name="propertyKey[]" value="${prop.key}" required>
                            <input type="text" name="propertyValue[]" value="${prop.value}" required>
                            <button type="button" class="remove-btn">Remove</button>
                        </div>
                    `);
                    });

// Populate accessories
                    $('#accessoriesList').empty();
                    response.accessories.forEach(function(acc) {
                        $('#accessoriesList').append(`
                            <div class="dynamic-item">
                                <input type="text" name="accessoryName[]" value="${acc.name}" required>
                                <label>
                                    <input type="checkbox" name="accessoryInventory[]" ${acc.quantity !== null ? 'checked' : ''}>
                                    In inventory
                                </label>
                                <button type="button" class="remove-btn">Remove</button>
                            </div>
                        `);
                    });

                    // Add event listener for remove button to delete only the clicked item
                    $(document).on('click', '.remove-btn', function() {
                        $(this).closest('.dynamic-item').remove();
                    });

                    // Populate allocations (entitlement groups)
                    $('#allocations').val(response.entitlement_groups.map(eg => eg.eg_id)).trigger('change');

                    // Populate categories (assuming it's part of the response)
                    if (response.categories) {
                        $('#categories').val(response.categories.map(c => c.id)).trigger('change');
                    }

                    // Populate compatibles
                    $('#compatibles').val(response.compatibles.map(c => c.id)).trigger('change');

                    // Populate existing images
                    $('#imagesList').empty();
                    response.images.forEach(function(image) {
                        $('#imagesList').append(`
                            <div class="file-item">
                                <a href="${image["thumbnail-url"]}" target="_blank"><img src="${image["thumbnail-url"]}" alt="Lights"/> </a>
                                <a href="${image.url}"  target="_blank"> <span>${image.filename}</span></a>
                                <button type="button" class="remove-file-btn" data-file-id="${image.id}">Remove</button>
                            </div>
                        `);
                    });

                    // Populate existing attachments
                    $('#attachmentsList').empty();
                    response.attachments.forEach(function(attachment) {
                        $('#attachmentsList').append(`
                            <div class="file-item">
                                <span>${attachment.filename}</span>
                                <button type="button" class="remove-file-btn" data-file-id="${attachment.id}">Remove</button>
                            </div>
                        `);
                    });

                    $('body').addClass('save-success');
                    setTimeout(function() {
                        $('body').removeClass('save-success');
                    }, 3000);
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching model: ' + error);
                    $('body').addClass('save-failed');
                    setTimeout(function() {
                        $('body').removeClass('save-failed');
                    }, 3000);
                }
            });
        });


        $('#testImage').ready(function() {
            // alert('fetchModelBtn');

            var modelId = $('#fetchModelId').val();
            var poolId = $('#poolId').val();

            fetch("http://localhost:3260/inventory/images/fe8e42a0-1d31-4449-8c91-24c17ddd5d10/thumbnail", {
                headers: {
                    "Accept": "image/jpeg" // This specifies that you’re expecting an image in response
                }
            })
                .then(response => {
                    if (response.ok) {
                        console.log("create blob()")
                        return response.blob(); // Convert the response to a blob
                    }
                    throw new Error('Network response was not ok.');
                })
                .then(blob => {
                        console.log("todo: imgUrl create")
                    const imgUrl = URL.createObjectURL(blob);
                    document.getElementById('testImage').src = imgUrl; // Assumes you have an <img id="myImage">
                        console.log("imgUrl created")
                })
                .catch(error => {
                    console.error('There has been a problem with your fetch operation:', error);
                });

        });


        // Add Property
        $('#addProperty').click(function() {
            $('#propertiesList').append(`
                <div class="dynamic-item">
                    <input type="text" name="propertyKey[]" placeholder="Key" required>
                    <input type="text" name="propertyValue[]" placeholder="Value" required>
                    <button type="button" class="remove-btn">Remove</button>
                </div>
            `);
        });

        // Add Accessory
        $('#addAccessory').click(function() {
            $('#accessoriesList').append(`
                <div class="dynamic-item">
                    <input type="text" name="accessoryName[]" placeholder="Accessory name" required>
                    <label>
                        <input type="checkbox" name="accessoryInventory[]">
                        In inventory
                    </label>
                    <button type="button" class="remove-btn">Remove</button>
                </div>
            `);
        });

        // Remove dynamic item
        $(document).on('click', '.remove-btn', function() {
            $(this).parent().remove();
        });

        // Handle file selection for images
        $('#images').change(function() {
            updateFileList(this, '#imagesList');
        });

        // Handle file selection for attachments
        $('#attachments').change(function() {
            updateFileList(this, '#attachmentsList');
        });

        // Update file list
        function updateFileList(input, listSelector) {
            var fileList = $(listSelector);
            fileList.empty();
            if (input.files && input.files.length > 0) {
                for (var i = 0; i < input.files.length; i++) {
                    var fileName = input.files[i].name;
                    fileList.append(`
                        <div class="file-item">
                            <span>${fileName}</span>
                            <button type="button" class="remove-file-btn" data-file-index="${i}">Remove</button>
                        </div>
                    `);
                }
            }
        }

        // Remove file from list
        $(document).on('click', '.remove-file-btn', function() {
            var fileIndex = $(this).data('file-index');
            var inputId = $(this).closest('.file-list').attr('id') === 'imagesList' ? 'images' : 'attachments';
            removeFile(inputId, fileIndex);
        });

        // Remove file from input
        function removeFile(inputId, index) {
            var input = document.getElementById(inputId);
            var files = Array.from(input.files);
            files.splice(index, 1);

            // Create a new FileList object
            var dataTransfer = new DataTransfer();
            files.forEach(file => { dataTransfer.items.add(file); });
            input.files = dataTransfer.files;

            // Update the file list display
            updateFileList(input, `#${inputId}List`);
        }

        // Clear form fields
        function clearForm() {
            $('#modelForm')[0].reset();
            $('#propertiesList').empty();
            $('#accessoriesList').empty();
            $('#imagesList').empty();
            $('#attachmentsList').empty();
            $('select').val(null).trigger('change');
        }

        // Form submission
        $('#modelForm').submit(function(e) {
            e.preventDefault();
            var formData = new FormData(this);

            // Prepare properties
            var properties = [];
            $('input[name="propertyKey[]"]').each(function(index) {
                properties.push({
                    key: $(this).val(),
                    value: $('input[name="propertyValue[]"]').eq(index).val()
                });
            });
            formData.append('properties', JSON.stringify(properties));

            // Prepare accessories
            var accessories = [];
            $('input[name="accessoryName[]"]').each(function(index) {
                accessories.push({
                    name: $(this).val(),
                    inventory_bool: $('input[name="accessoryInventory[]"]').eq(index).is(':checked')
                });
            });
            formData.append('accessories', JSON.stringify(accessories));
            formData.delete('accessoryName[]');
            formData.delete('propertyKey[]');
            formData.delete('propertyValue[]');

            // Get the poolId value
            var poolId = $('#poolId').val();
            var modelId = $('#fetchModelId').val();

            var config = FNC_CONFIG(poolId, modelId);

            // Send form data to API
            $.ajax({
                url: config.url,
                method: config.method,
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'Accept': 'application/json'
                },
                success: function(response) {
                    console.log('Model created successfully!');
                    clearForm(); // Clear the form after successful save

                    if( !CONST_IS_CREATE_FORM) {
                        // $('#fetchModelId').val(response.model_id);
                        $('#fetchModelBtn').click()
                    }


                    $('body').addClass('save-success');
                    setTimeout(function() {
                        $('body').removeClass('save-success');
                    }, 3000);
                },
                error: function(xhr, status, error) {
                    console.error('Error creating model: ' + error);
                    $('body').addClass('save-failed');
                    setTimeout(function() {
                        $('body').removeClass('save-failed');
                    }, 3000);
                }
            });
        });
    });
</script>
</body>
</html>