<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Model</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input[type="text"], input[type="file"], textarea, select { width: 100%; padding: 8px; box-sizing: border-box; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .dynamic-list { margin-top: 10px; }
        .dynamic-item { display: flex; gap: 10px; margin-bottom: 10px; }
        .remove-btn { background-color: #dc3545; }
        .file-list { margin-top: 10px; }
        .file-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        body.save-success {
            border: 1em solid #b8f4b8;
            transition: border 0.3s ease-in-out;
        }
        body.save-failed {
            border: 1em solid red;
            transition: border 0.3s ease-in-out;
        }
    </style>
</head>
<body>
<h1>Create New Model</h1>

<div class="form-group">
    <label for="poolId">Pool ID</label>
    <input type="text" id="poolId" name="poolId" value="8bd16d45-056d-5590-bc7f-12849f034351">
</div>

<form id="modelForm">
    <div class="form-group">
        <label for="product">Product *</label>
        <input type="text" id="product" name="product" required>
    </div>
    <div class="form-group">
        <label for="version">Version</label>
        <input type="text" id="version" name="version">
    </div>
    <div class="form-group">
        <label for="manufacturer">Manufacturer</label>
        <select id="manufacturer" name="manufacturer"></select>
    </div>
    <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" name="description"></textarea>
    </div>
    <div class="form-group">
        <label for="technicalDetails">Technical Details</label>
        <textarea id="technicalDetails" name="technicalDetails"></textarea>
    </div>
    <div class="form-group">
        <label for="internalDescription">Internal Description</label>
        <textarea id="internalDescription" name="internalDescription"></textarea>
    </div>
    <div class="form-group">
        <label>Properties</label>
        <div id="propertiesList" class="dynamic-list"></div>
        <button type="button" id="addProperty">Add Property</button>
    </div>
    <div class="form-group">
        <label for="images">Images</label>
        <input type="file" id="images" name="images" multiple accept="image/*">
        <div id="imagesList" class="file-list"></div>
    </div>
    <div class="form-group">
        <label for="attachments">Attachments</label>
        <input type="file" id="attachments" name="attachments" multiple>
        <div id="attachmentsList" class="file-list"></div>
    </div>
    <div class="form-group">
        <label>
            <input type="checkbox" id="isPackage" name="isPackage">
            This is a package
        </label>
    </div>
    <div class="form-group">
        <label for="allocations">Allocations</label>
        <select id="allocations" name="allocations" multiple></select>
    </div>
    <div class="form-group">
        <label for="categories">Categories</label>
        <select id="categories" name="categories" multiple></select>
    </div>
    <div class="form-group">
        <label for="compatibles">Compatible Models</label>
        <select id="compatibles" name="compatibles" multiple></select>
    </div>
    <div class="form-group">
        <label>Accessories</label>
        <div id="accessoriesList" class="dynamic-list"></div>
        <button type="button" id="addAccessory">Add Accessory</button>
    </div>
    <div class="form-group">
        <button type="submit">Save Model</button>
    </div>
</form>

<script>
    $(document).ready(function() {
        function fetchOptions(url, selectId) {
            fetch(url, {headers: {'Accept': 'application/json'}})
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Select an option</option>';

                    if (selectId === 'compatibles') {
                        data = data.data;
                    }

                    data.forEach(item => {
                        const option = document.createElement('option');

                        if (selectId === 'manufacturer') {
                            option.value = item;
                            option.textContent = item;
                            select.appendChild(option);
                            return;
                        }

                        if (selectId === 'compatibles') {
                            option.value = item.model_id;
                            option.textContent = item.product;
                            select.appendChild(option);
                            return;
                        }

                        option.value = item.id;
                        option.textContent = item.name;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error:', error));
        }

        function updateDropdowns(poolId) {
            fetchOptions(`http://localhost:3260/inventory/manufacturers`, 'manufacturer');
            fetchOptions(`http://localhost:3260/inventory/${poolId}/entitlement-groups`, 'allocations');
            fetchOptions(`http://localhost:3260/inventory/${poolId}/model-groups`, 'categories');
            fetchOptions(`http://localhost:3260/inventory/models-compatibles`, 'compatibles');
        }

        // Initialize dropdowns on page load
        var initialPoolId = $('#poolId').val();
        updateDropdowns(initialPoolId);

        // Update dropdowns when pool ID changes
        $('#poolId').change(function() {
            var newPoolId = $(this).val();
            updateDropdowns(newPoolId);
        });

        // Add Property
        $('#addProperty').click(function() {
            $('#propertiesList').append(`
                <div class="dynamic-item">
                    <input type="text" name="propertyKey[]" placeholder="Key" required>
                    <input type="text" name="propertyValue[]" placeholder="Value" required>
                    <button type="button" class="remove-btn">Remove</button>
                </div>
            `);
        });

        // Add Accessory
        $('#addAccessory').click(function() {
            $('#accessoriesList').append(`
                <div class="dynamic-item">
                    <input type="text" name="accessoryName[]" placeholder="Accessory name" required>
                    <label>
                        <input type="checkbox" name="accessoryInventory[]">
                        In inventory
                    </label>
                    <button type="button" class="remove-btn">Remove</button>
                </div>
            `);
        });

        // Remove dynamic item
        $(document).on('click', '.remove-btn', function() {
            $(this).parent().remove();
        });

        // Handle file selection for images
        $('#images').change(function() {
            updateFileList(this, '#imagesList');
        });

        // Handle file selection for attachments
        $('#attachments').change(function() {
            updateFileList(this, '#attachmentsList');
        });

        // Update file list
        function updateFileList(input, listSelector) {
            var fileList = $(listSelector);
            fileList.empty();
            if (input.files && input.files.length > 0) {
                for (var i = 0; i < input.files.length; i++) {
                    var fileName = input.files[i].name;
                    fileList.append(`
                        <div class="file-item">
                            <span>${fileName}</span>
                            <button type="button" class="remove-file-btn" data-file-index="${i}">Remove</button>
                        </div>
                    `);
                }
            }
        }

        // Remove file from list
        $(document).on('click', '.remove-file-btn', function() {
            var fileIndex = $(this).data('file-index');
            var inputId = $(this).closest('.file-list').attr('id') === 'imagesList' ? 'images' : 'attachments';
            removeFile(inputId, fileIndex);
        });

        // Remove file from input
        function removeFile(inputId, index) {
            var input = document.getElementById(inputId);
            var files = Array.from(input.files);
            files.splice(index, 1);

            // Create a new FileList object
            var dataTransfer = new DataTransfer();
            files.forEach(file => { dataTransfer.items.add(file); });
            input.files = dataTransfer.files;

            // Update the file list display
            updateFileList(input, `#${inputId}List`);
        }

        // Clear form fields
        function clearForm() {
            $('#modelForm')[0].reset();
            $('#propertiesList').empty();
            $('#accessoriesList').empty();
            $('#imagesList').empty();
            $('#attachmentsList').empty();
        }

        // Form submission
        $('#modelForm').submit(function(e) {
            e.preventDefault();
            var formData = new FormData(this);

            // Prepare properties
            var properties = [];
            $('input[name="propertyKey[]"]').each(function(index) {
                properties.push({
                    key: $(this).val(),
                    value: $('input[name="propertyValue[]"]').eq(index).val()
                });
            });
            formData.append('properties', JSON.stringify(properties));

            // Prepare accessories
            var accessories = [];
            $('input[name="accessoryName[]"]').each(function(index) {
                accessories.push({
                    name: $(this).val(),
                    inventory_bool: $('input[name="accessoryInventory[]"]').eq(index).is(':checked')
                });
            });
            formData.append('accessories', JSON.stringify(accessories));

            // Get the poolId value
            var poolId = $('#poolId').val();

            // Send form data to API
            $.ajax({
                url: 'http://localhost:3260/inventory/' + poolId + '/model',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'Accept': 'application/json'
                },
                success: function(response) {
                    console.log('Model created successfully!');
                    clearForm(); // Clear the form after successful save
                    $('body').addClass('save-success');
                    setTimeout(function() {
                        $('body').removeClass('save-success');
                    }, 3000);
                },
                error: function(xhr, status, error) {
                    console.error('Error creating model: ' + error);
                    $('body').addClass('save-failed');
                    setTimeout(function() {
                        $('body').removeClass('save-failed');
                    }, 3000);
                }
            });
        });
    });
</script>
</body>
</html>