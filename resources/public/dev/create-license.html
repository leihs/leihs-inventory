<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New License (dyn)</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        function generateLinks() {
            const poolId = document.getElementById('poolId').value;
            const modelId = document.getElementById('licenseId').value;

            const stagingLink = `https://staging.leihs.zhdk.ch/manage/${poolId}/items/${modelId}/edit?return_url=/manage/${poolId}/inventory`;
            const testLink = `https://test.leihs.zhdk.ch/manage/${poolId}/items/${modelId}/edit?return_url=/manage/${poolId}/inventory`;

            const stagingAdminLink = `https://staging.leihs.zhdk.ch/admin/users`;
            const testAdminLink = `https://test.leihs.zhdk.ch/admin/users`;

            document.getElementById('stagingLink').href = stagingLink;
            document.getElementById('stagingLink').innerText = "*/staging/manage/-Link to Edit";

            document.getElementById('testLink').href = testLink;
            document.getElementById('testLink').innerText = "*/test/manage/-Link to Edit";


            document.getElementById('stagingAdminLink').href = stagingAdminLink;
            document.getElementById('stagingAdminLink').innerText = "Staging-Admin";

            document.getElementById('testAdminLink').href = testAdminLink;
            document.getElementById('testAdminLink').innerText = "Test-Admin";
        }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <style>
        .links {
            padding: 0.5em 1em 1em 1em;
            margin-top: 1em;
            background-color: #f4f4f4;
            border-style: dashed;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input[type="text"], input[type="file"], textarea, select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }

        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        .myBtn {
            margin-top: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .file-list {
            margin-top: 10px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .file-item span {
            flex-grow: 1;
        }

        .remove-file-btn, .remove-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            cursor: pointer;
            padding: 5px 10px;
        }

        .remove-file-btn:hover, .remove-btn:hover {
            background-color: #a71d2a;
        }

        body.save-success {
            border: 1em solid #b8f4b8;
            transition: border 0.3s ease-in-out;
        }

        body.no-result-success {
            border: 1em solid #BFBFBF1C;
            transition: border 0.3s ease-in-out;
        }

        body.save-failed {
            border: 1em solid red;
            transition: border 0.3s ease-in-out;
        }

        .colored-row {
            background-color: navajowhite;
        }
    </style>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            /*background-color: #f9f9f9;*/
        }

        .form-group {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .form-group h3 {
            margin-bottom: 15px;
            font-size: 1.25em;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .form-item {
            margin-bottom: 15px;
        }

        .form-item label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .form-item input[type="text"],
        .form-item input[type="date"],
        .form-item textarea,
        .form-item select {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            transition: all 0.3s;
        }

        .form-item input[type="text"]:focus,
        .form-item input[type="date"]:focus,
        .form-item textarea:focus,
        .form-item select:focus {
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }

        .form-item .radio-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .form-item input[type="radio"] {
            margin-right: 10px;
        }

        .form-item input[type="radio"]:focus {
            outline: 2px solid #007bff;
        }

        .form-item label[for^="is_borrowable_"] {
            margin: 0;
        }

        .form-item input[type="radio"]:checked + label {
            color: #007bff;
        }

        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }
    </style>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .warning-title {
            display: flex;
            align-items: center;
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 10px 15px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 1.2em;
            font-weight: bold;
            margin: 20px 0;
        }

        .warning-title i {
            margin-right: 10px;
            color: #856404;
            font-size: 1.5em;
        }
    </style>

    <style>
        /* Styling for form group and items */
        .form-group {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .form-group h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .form-item {
            margin-bottom: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
        }

        /* Hide the default checkbox */
        .checkbox-item input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        /* Custom checkbox styling */
        .checkbox-item label {
            position: relative;
            padding-left: 35px;
            cursor: pointer;
            user-select: none;
            font-size: 1em;
            color: #333;
        }

        /* Create a custom checkbox design */
        .checkbox-item label::before {
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 20px;
            width: 20px;
            border: 2px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            transition: background-color 0.2s, border-color 0.2s;
        }

        /* Checkbox hover effect */
        .checkbox-item input[type="checkbox"]:hover + label::before {
            border-color: #007bff;
        }

        /* Checked state for the checkbox */
        .checkbox-item input[type="checkbox"]:checked + label::before {
            background-color: #007bff;
            border-color: #007bff;
        }

        /* Custom checkmark */
        .checkbox-item input[type="checkbox"]:checked + label::after {
            content: "";
            position: absolute;
            left: 6px;
            top: 50%;
            transform: translateY(-50%) rotate(45deg);
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transition: transform 0.2s;
        }
    </style>

    <style>
        ul.dev-page-menu {
            list-style-type: none; /* Remove default bullets */
            padding: 0; /* Remove default padding */
            margin: 0; /* Remove default margin */
            display: flex; /* Display items in a row */
            justify-content: space-around; /* Space items evenly */
            background-color: #f4f4f4; /* Light gray background for the list */
            border: 1px solid #ddd; /* Add a border around the list */
            border-radius: 5px; /* Round the corners */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Add a subtle shadow */
        }

        ul li {
            margin: 0; /* Remove default margin */
        }

        ul.dev-page-menu li a {
            display: block;
            padding: 10px 15px; /* Add padding for better click area */
            text-decoration: none; /* Remove default underline */
            color: #333; /* Set text color */
            font-weight: 500; /* Make the font semi-bold */
            transition: background-color 0.3s, color 0.3s; /* Smooth hover effect */
            border-radius: 5px; /* Match border radius with the list */
        }

        ul.dev-page-menu li a:hover {
            background-color: #007BFF; /* Change background color on hover */
            color: white; /* Change text color on hover */
        }
    </style>
</head>
<body>
<ul class="dev-page-menu">
    <li><a target="_blank" href="/inventory/8bd16d45-056d-5590-bc7f-12849f034351/dev/model">Model</a></li>
    <li><a target="_blank" href="/inventory/8bd16d45-056d-5590-bc7f-12849f034351/dev/software">Software</a></li>
    <li><a target="_blank" href="/inventory/8bd16d45-056d-5590-bc7f-12849f034351/dev/license">License (d)</a></li>
    <li><a target="_blank" href="/inventory/8bd16d45-056d-5590-bc7f-12849f034351/dev/item">Item (d)</a></li>
    <li><a target="_blank" href="/inventory/8bd16d45-056d-5590-bc7f-12849f034351/dev/option">Option</a></li>
    <li><a target="_blank" href="/inventory/8bd16d45-056d-5590-bc7f-12849f034351/dev/package">Package (d)</a></li>
    <li><a target="_blank" href="/inventory/api-docs/index.html#/Auth/get_inventory_login">| Login</a></li>
    <li><a target="_blank" href="/inventory/api-docs/index.html#/Dev/get_inventory_dev_update_accounts">updateCreds</a>
    </li>
</ul>

<div class="links">
    <h3>Links to Test/Staging <h5>(generated by Options-Attributes)</h5></h3>

    <div>
        <p><a id="testLink" href="#" target="_blank"></a></p>
        <p><a id="testAdminLink" href="https://test.leihs.zhdk.ch/admin/users" target="_blank">Test-Admin</a></p>
        <br/>
        <p><a id="stagingLink" href="#" target="_blank"></a></p>
        <p><a id="stagingAdminLink" href="https://staging.leihs.zhdk.ch/admin/users" target="_blank">Staging-Admin</a>
        </p>
    </div>
    <button class="myBtn" style="background-color: orange" onclick="generateLinks()">Generate Links</button>
</div>

<br/><br/>
<br/><br/>

<h1 id="formTitle">Create New License (dyn)</h1>

<h3>Options</h3>
<div class="form-group">
    <label for="poolId">Pool ID</label>
    <input type="text" id="poolId" name="poolId" value="8bd16d45-056d-5590-bc7f-12849f034351">
</div>
<div class="form-group">
    <label for="softwareId"><a target="_blank"
                               href="/inventory/api-docs/index.html#/Models%20by%20pool/get_inventory__pool_id__models">Software
        ID (model_id)</a> [softwareId] 70693141-92c2-5c8f-b5ae-59221da1e027</label>

    <input type="text" id="softwareId" name="softwareId" value="a8705e94-bb7c-50c0-9e43-e33197766fa1">
</div>

<div class="form-group">
    <label for="licenseId">License ID (item_id) [licenseId] 57f02a40-c047-4132-ad3b-ced9b398e104</label>
    <input type="text" id="licenseId" value="2b542bfc-ba81-4719-a8c9-231ce4849317">

    <button id="fetchLicenseBtn">Fetch License</button>
</div>


<div class="warning-title">
    <i class="fas fa-exclamation-triangle"></i>
    Warning: form is generated dynamically based on user-role (inventory_manager, inventory_admin, etc.)
</div>

<br/><br/><br/><br/>

<form id="softwareForm">
    <div id="dynamicFields"></div>
</form>

<script>

    const initSoftwareConfig = {
        placeholder: "Type to search software...",
        allowClear: true,           // Allow users to clear the selection
        minimumInputLength: 1,      // Only start searching after typing at least 1 character
        ajax: {
            url: function (params) {
                const searchTerm = params.term ? encodeURIComponent(params.term) : '';
                return `/inventory/manufacturers?type=Software&in-detail=true&search-term=${searchTerm}`;
            },
            data: function () {
                return {};
            },
            transport: function (params, success, failure) {
                // Abort the previous request if it exists
                if (currentRequest) {
                    currentRequest.abort();
                }

                // Set up the new request
                currentRequest = $.ajax(params)
                    .done(success)
                    .fail(failure);

                return currentRequest;
            },
            dataType: 'json',
            delay: 250, // Delay in ms to prevent too many requests
            processResults: function (data) {
                // Format the results for Select2
                return {
                    results: data.map(function (item) {
                        return {
                            id: item.id,   // Unique ID (value)
                            text: item.product  // Display text in the dropdown
                        };
                    })
                };
            },
            cache: true // Cache the results to avoid unnecessary network requests
        }
    }

    const initSupplierConfig = {
        placeholder: "Type to search software...",
        allowClear: true,           // Allow users to clear the selection
        minimumInputLength: 1,      // Only start searching after typing at least 1 character
        ajax: {
            url: function (params) {
                const searchTerm = params.term ? encodeURIComponent(params.term) : '';
                return `/inventory/supplier?search-term=${searchTerm}`;
            },
            data: function () {
                return {};
            },
            transport: function (params, success, failure) {
                // Abort the previous request if it exists
                if (currentRequest) {
                    currentRequest.abort();
                }

                // Set up the new request
                currentRequest = $.ajax(params)
                    .done(success)
                    .fail(failure);

                return currentRequest;
            },
            dataType: 'json',
            delay: 250, // Delay in ms to prevent too many requests
            processResults: function (data) {
                // Format the results for Select2
                return {
                    results: data.map(function (item) {
                        return {
                            id: item.id,   // Unique ID (value)
                            text: item.name  // Display text in the dropdown
                        };
                    })
                };
            },
            cache: true // Cache the results to avoid unnecessary network requests
        }
    }

    function addQuantityAllocationElement(quantity = '', room = '') {
        $('#propertiesList').append(`
        <div class="dynamic-item" style="display: inline-flex; gap: 8px; margin-bottom: 8px;">
            <input type="text" _name="quantityAllocationQuantity[]" placeholder="Key" value="${quantity}" required>
            <input type="text" _name="quantityAllocationRoom[]" placeholder="Value" value="${room}" required>
            <button type="button" class="remove-btn">Remove</button>
        </div>
    `);
    }

    function updateFileList(input, listSelector, inputId) {
        var fileList = $(listSelector);
        // fileList.empty();

        console.log(">> updateFileList1 > ", input.files);
        console.log(">> updateFileList2 > ", listSelector);

        if (input.files && input.files.length > 0) {
            for (var i = 0; i < input.files.length; i++) {
                var fileName = input.files[i].name;
                fileList.append(`
                        <div class="file-item">
                            <span>${fileName}</span>
                            <button type="button" ftpye="${inputId}" class="remove-file-btn" data-file-index="${i}">Remove</button>
                        </div>
                    `);
            }
        }
    }

    function updateFileList(input, listSelector, inputId, attachments = []) {
        var fileList = $(listSelector);

        // Handle files from input element
        if (input.files && input.files.length > 0) {
            console.log(">> updateFileList1 > Input Files:", input.files);
            for (var i = 0; i < input.files.length; i++) {
                var fileName = input.files[i].name;
                fileList.append(`
                <div class="file-item">
                    <span>${fileName}</span>
                    <button type="button" ftype="${inputId}" class="remove-file-btn" data-file-index="${i}">Remove</button>
                </div>
            `);
            }
        }

        // Handle files from response.data.attachments
        if (attachments.length > 0) {
            console.log(">> updateFileList2 > Attachments:", attachments);
            // <button type="button" ftype="${inputId}" class="remove-file-btn" data-attachment-id="${attachment.id}" data-attachment-index="${index}">Remove</button>
            attachments.forEach((attachment, index) => {
                fileList.append(`
                <div class="file-item" id="attachments-to-delete">
                    <span>${attachment.filename} (${attachment.content_type})</span>
                    <button type="button" ftype="${inputId}" class="remove-file-btn" data-attachment-id="${attachment.id}" >Remove</button>
                </div>
            `);
            });
        }
    }


    // Remove file from list
    $(document).on('click', '.remove-file-btn', function () {
        var fileId = $(this).data('fileId')
        var inputId = $(this).closest('.file-list').attr('id') === 'imagesList' ? 'images' : 'attachments';

        var toDelte = $(`#${inputId}-to-delete`).data('to-delete') || []
        toDelte.push(fileId)
        $(`#${inputId}-to-delete`).data('to-delete', toDelte)

        $(this).parent().remove();

    });

    // Remove file from list
    $(document).on('click', '.remove-attachment-btn', function () {
        let attachmentsList = $(this).closest("#attachmentsList")
        let id = $(this).attr("data-attachment-id")

        if (id != undefined) {
            let data = attachmentsList.data("to-delete") || []
            data.push(id)
            attachmentsList.data("to-delete", data)
        }

        $(this).parent().remove();
    });

    function deleteParamsFromPutPostFormData(formData) {
        // formData.delete("model_id");
        formData.delete("inventory_pool_id");
        formData.delete("myOldSoftware");
    }


    function checkFormDataOrThrow(formData, modelId) {
        if (formData == undefined) {
            throw new Error("formData is undefined")
        }

        // if (['null', undefined, null].includes(formData.get("supplier_id"))) {
        //     // formData.delete("supplier_id");
        //     throw new Error("Supplier is required");
        // }

        // for url
        if (['null', undefined, null].includes(modelId)) {
            // formData.delete("supplier_id");
            throw new Error("Software is required");
        }
    }

    function renameFormDataKey(formData, oldKey, newKey) {
        if (formData.has(oldKey)) {
            // Get the value of the old key
            const value = formData.get(oldKey);

            // Add the value to the new key
            formData.append(newKey, value);

            // Delete the old key
            formData.delete(oldKey);
        }
    }


    function renameLabel(data) {
        if (data.label == "Responsible department") {
            data.label = "ResponsibleDepartment";
        }

        return data
    }

    function getQuantityAllocationAsJsonArray() {
        let propertiesArray = [];

        $('#propertiesList .dynamic-item').each(function () {
            let quantity = $(this).find('input[_name="quantityAllocationQuantity[]"]').val();
            let name = $(this).find('input[_name="quantityAllocationRoom[]"]').val();

            // Push the key-value pair into the array as a map
            propertiesArray.push({
                quantity: quantity,
                room: name
            });
        });

        return propertiesArray;
    }

    function generateFormFields(config, formId) {
        const form = $('#dynamicFields');
        form.empty(); // Clear previous fields if any

        config.forEach((fieldConfig) => {
            let data = fieldConfig.data;
            data = renameLabel(data)
            const group = data.group || "General";
            let groupContainer = form.find(`.form-group[data-group="${group}"]`);

            if (groupContainer.length === 0) {
                groupContainer = $(`
                <div class="form-group" data-group="${group}">
                    <h3>${group}</h3>
                </div>
            `);
                form.append(groupContainer);
            }

            let field;
            const fieldId = fieldConfig.id;

            switch (data.type) {
                case 'autocomplete':
                case 'autocomplete-search':


                    oldField = ""
                    if (data.label == "Software") {
                        oldField = `<input type="hidden" id="myOld${data.label}" name="myOld${data.label}"></input>`
                    }

                    field = $(`
                    <div class="form-item">
                        <label style="color:orange">${data.type} > '${data.label}' '${data.values}'</label>
                        <label for="my${data.label}">${data.label}</label>
                        <select id="my${data.label}" name="my${data.label}"></select>
                        ${oldField}
                    </div>
                `);
                    break;

                case 'text':
                case 'date':
                    field = $(`
                    <div class="form-item">
                        <label for="${fieldId}">${data.label}${data.required ? " *" : ""}</label>
                        <input type="${data.type}" id="${fieldId}" name="${data.attribute}" ${data.required ? "required" : ""}>
                    </div>
                `);
                    break;

                case 'textarea':
                    field = $(`
                    <div class="form-item">
                        <label for="${fieldId}">${data.label}${data.required ? " *" : ""}</label>
                        <textarea id="${fieldId}" name="${data.attribute}" ${data.required ? "required" : ""}></textarea>
                    </div>
                `);
                    break;

                case 'composite':
                    field = $(`
                    <div class="form-item">
                        <label for="${fieldId}">${data.label}${data.required ? " *" : ""}</label>
                        <div id="propertiesList">

                        </div>
                        <button type="button" id="addProperty">Add Property</button>
                    </div>
                `);

                    break;


                case 'select':
                    let values = Array.isArray(data.values) ? [...data.values] : []; // Ensure `values` is an array

                    // Check if `data.default` exists and is not in `values`
                    if (data.default && !values.some(option => option.value === data.default)) {
                        values.unshift({value: data.default, label: `Default (${data.default})`}); // Add default as the first option
                    }

                    const options = values.map(option => `
                        <option value="${option.value}" ${data.default === option.value ? "selected" : ""}>
                            ${option.label}
                        </option>`).join("");

                    field = $(`
                        <div class="form-item">
                            <label for="${fieldId}">${data.label}${data.required ? " *" : ""}</label>
                            <select id="${fieldId}" name="${data.attribute}" ${data.required ? "required" : ""}>
                                ${options}
                            </select>
                        </div>
                    `);

                    if (!Array.isArray(data.values)) {
                        console.warn(`Field "${fieldId}" has no valid options to populate the select dropdown.`);
                    }
                    break;

                case 'radio':
                    if (Array.isArray(data.values)) {
                        const radioButtons = data.values.map((option, index) => {
                            const radioId = `${fieldId}_${index}`;
                            return `
                            <div class="radio-item">
                                <input type="radio" id="${radioId}" name="${data.attribute}" value="${option.value}" ${data.default === option.value ? "checked" : ""}>
                                <label for="${radioId}">${option.label}</label>
                            </div>
                        `;
                        }).join("");

                        field = $(`
                        <div class="form-item">
                            <label>${data.label}${data.required ? " *" : ""}</label>
                            ${radioButtons}
                        </div>
                    `);
                    } else {
                        console.warn(`Field "${fieldId}" has no valid options to populate the radio buttons.`);
                    }
                    break;

                case 'checkbox':
                    // Add multiple checkboxes if data.values is an array
                    if (Array.isArray(data.values)) {
                        const checkboxes = data.values.map((option, index) => {
                            const checkboxId = `${fieldId}_${index}`;
                            return `
                            <div class="checkbox-item">
                                <input type="checkbox" id="${checkboxId}" name="${data.attribute}" value="${option.value}" ${option.checked ? "checked" : ""}>
                                <label for="${checkboxId}">${option.label}</label>
                            </div>
                        `;
                        }).join("");

                        field = $(`
                        <div class="form-item">
                            <label>${data.label}${data.required ? " *" : ""}</label>
                            ${checkboxes}
                        </div>
                    `);
                    } else {
                        // Single checkbox (if no values array is provided)
                        field = $(`
                        <div class="form-item checkbox-item">
                            <input type="checkbox" id="${fieldId}" name="${data.attribute}" ${data.default ? "checked" : ""}>
                            <label for="${fieldId}">${data.label}</label>
                        </div>
                    `);
                    }
                    break;

                case 'attachment':
                    // Multiple file upload
                    //     field = $(`
                    //     <div class="form-item">
                    //         <label for="${fieldId}">${data.label}${data.required ? " *" : ""}</label>
                    //         <input type="file" id="${fieldId}" name="${data.attribute}" multiple ${data.required ? "required" : ""}>
                    //     </div>
                    // `);

                    field = $(`
                    <div class="form-group">
<!--                        <b><label for="attachments">Anh√§nge</label></b>-->
                        <label for="${fieldId}">${data.label}${data.required ? " *" : ""}</label>
                        <input type="file" id="attachments" name="attachments" multiple>
                        <input type="hidden" id="attachments-to-delete" name="attachments-to-delete" />
                        <div id="attachmentsList" class="file-list"></div>
                    </div>
                `);
                    break;

                default:
                    console.warn(`Unsupported field type: ${data.type} ${fieldId}; ${data.label} ${data.attribute}`);
            }

            if (field) {
                groupContainer.append(field);
            }
        });

        // After generating form fields, add the save button if not already present
        if ($("#saveButton").length === 0) {
            form.append('<button type="submit" id="saveButton">Save License</button>');
        }

        // TODO: define/trigger init
        $("#mySoftware").select2(initSoftwareConfig)
        $("#mySupplier").select2(initSupplierConfig)


        // Add Property Button Click Event
        $('#addProperty').click(function () {
            addQuantityAllocationElement(); // Add an empty row when the button is clicked
        });

        // Trigger Click with Parameters
        $('#triggerAddProperty').click(function () {
            addQuantityAllocationElement('DefaultKey', 'DefaultValue'); // Pass parameters to pre-fill the fields
        });


        $(document).on('click', '.remove-btn', function () {
            $(this).closest('.dynamic-item').remove();
        });

        // Handle file selection for attachments
        $('#attachments').change(function () {
            updateFileList(this, '#attachmentsList', 'attachments');
        });

    }


    function showResultEffect(effectClass) {
        $('body').addClass(effectClass);
        setTimeout(() => $('body').removeClass(effectClass), 3000);
    }


    function setupDongleAndRetiredHandler(data) {
        // project handling
        let reference = $('[name="properties,reference"]:checked').val();
        $(`[name="properties,reference"][value="${reference}"]`).prop('checked', true);
        // $('[name="properties,reference"][value="invoice"]').prop('checked', true);
        // if(reference=="dongle"){
        //     $("#properties_dongle_id").prop("disabled", false)
        // }else{
        //     $("#properties_dongle_id").prop("disabled", true)
        // }

        function handleReferenceSwitch() {
            let reference = $('[name="properties,reference"]:checked').val();
            console.log("reference", reference)
            if (reference == "invoice") {
                $("#properties_project_number").prop("disabled", true)
                $("#properties_project_number").val("")
            } else {
                $("#properties_project_number").prop("disabled", false)
            }
        }

        handleReferenceSwitch()

        $('[name="properties,reference"][value="investment"]').off("change").on("change", handleReferenceSwitch)
        $('[name="properties,reference"][value="invoice"]').off("change").on("change", handleReferenceSwitch)


        // dongle handling
        if ($("#properties_activation_type").val() == "dongle") {
            $("#properties_dongle_id").prop("disabled", false)
        } else {
            $("#properties_dongle_id").prop("disabled", true)
        }

        $("#properties_activation_type").off("change").on("change", function () {
            if ($("#properties_activation_type").val() == "dongle") {
                $("#properties_dongle_id").prop("disabled", false)
            } else {
                $("#properties_dongle_id").prop("disabled", true)
            }
        })

        // retired handling
        if (data != undefined) {
            $("#retired").data("retired", data.retired)
            $("#retired").val(String(data.retired))
        }
        if ($("#retired").val() == 'false') {
            $("#retired_reason").prop("disabled", true)
            $("#retired_reason").val("")
        } else {
            $("#retired_reason").prop("disabled", false)
        }

        $("#retired").off("change").on("change", function () {
            if ($("#retired").val() == 'false') {
                // if($("#retired").val()== undefined){
                $("#retired_reason").prop("disabled", true)
                $("#retired_reason").val("")
            } else {
                $("#retired_reason").prop("disabled", false)
            }
        })

    }

    function appendQuantityAllocationToFormData(formData) {
        const properties = {}; // Object to hold extracted properties
        const keysToDelete = []; // To keep track of keys to be deleted

        // Iterate through formData entries
        for (const [key, value] of formData.entries()) {
            if (key.startsWith("properties,")) {
                // Extract the property name after "properties,"

                //     console.log("key???", key, value)
                // if(key == 'properties,operating_system'){
                //     console.log("key", key, value)
                //     debugger
                // }

                const propertyName = key.split(",")[1];
                properties[propertyName] = value; // Add to properties object

                if (key == 'properties,operating_system') {
                    const value = Array.from(
                        document.querySelectorAll('input[type="checkbox"][name="properties,operating_system"]:checked')
                    ).map(checkbox => checkbox.value);
                    properties[propertyName] = value; // Add to properties object
                }

                if (key == 'properties,installation') {
                    const value = Array.from(
                        document.querySelectorAll('input[type="checkbox"][name="properties,installation"]:checked')
                    ).map(checkbox => checkbox.value);
                    properties[propertyName] = value; // Add to properties object
                }

                // Mark the key for deletion
                keysToDelete.push(key);
            }
        }


        let quantityAllocation = getQuantityAllocationAsJsonArray()
        properties["quantity_allocations"] = quantityAllocation


        // Remove all keys marked for deletion
        keysToDelete.forEach(key => formData.delete(key));

        // Add the JSON stringified properties object back into formData
        formData.append("properties", JSON.stringify(properties));

        return formData;
    }


    function fetchOptions(url, selectId) {
        fetch(url, {headers: {Accept: "application/json"}})
            .then((response) => response.json())
            .then((data) => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select an option</option>';
                data.forEach((item) => {
                    const option = document.createElement("option");
                    option.value = item;
                    option.textContent = item;
                    select.appendChild(option);
                });
                initSelect2(selectId);
            })
            .catch((error) => console.error("Error:", error));
    }

    const initialPoolId = $("#poolId").val();

    let currentRequest = null;
    // $("#mySoftware").on("change", function () {

    $("#mySoftware").select2(initSoftwareConfig)

    // Optional: Adding an onchange event listener to log the selected value
    $("#mySoftware").on("change", function () {
        const selectedValue = $(this).val();
        console.log(">o> Selected software:", selectedValue);
    });


    function initResponsibleData(init_data) {
        // set responsible department
        const poolId = $("#poolId").val();
        const apiUrl = `/inventory/${poolId}/entitlement-groups`;

        // Make the GET request to fetch data
        $.ajax({
            url: apiUrl,
            method: "GET",
            headers: {Accept: "application/json"},
            success: function (data) {
                // Assuming `data` is an array of objects with `id` and `name` properties
                const $select = $("#myResponsibleDepartment");
                $select.empty(); // Clear any existing options

                // Populate the <select> with options
                data.forEach(item => {
                    $select.append($("<option>", {
                        value: item.id,
                        text: item.name
                    }));
                });

                $select.val(init_data.responsible_department)
            },
            error: function (xhr, status, error) {
                console.error("Error fetching data:", error);
            }
        });
    }

    function initOwnersData(init_data) {
        // set responsible department
        const poolId = $("#poolId").val();
        const apiUrl = `/inventory/owners`;

        // Make the GET request to fetch data
        $.ajax({
            url: apiUrl,
            method: "GET",
            headers: {Accept: "application/json"},
            success: function (data) {
                // Assuming `data` is an array of objects with `id` and `name` properties
                const $select = $("#myOwner");
                $select.empty(); // Clear any existing options

                // Populate the <select> with options
                data.forEach(item => {
                    $select.append($("<option>", {
                        value: item.id,
                        text: item.name
                    }));
                });

                $select.val(init_data.inventory_pool_id)
            },
            error: function (xhr, status, error) {
                console.error("Error fetching data:", error);
            }
        });
    }


    $(document).ready(function () {
        let CONST_IS_CREATE_FORM = true;

        // data .. html-field
        const fieldMapping = {
            "serial_number": "serial_number",
            "note": "note",
            "retired_reason": "retired_reason",

            "maintenance_price": "properties_maintenance_price",
            "price": "price",
            "p4u": "properties_p4u",

            "dongle_id": "properties_dongle_id",
            "project_number": "properties_project_number",

            "invoice_date": "invoice_date",
            "procured_by": "properties_procured_by",
            "properties_maintenance_price": "properties_maintenance_price",
            "inventory_code": "inventory_code",
            "total_quantity": "properties_total_quantity",
            "activation_type": "properties_activation_type",
            "license_type": "properties_license_type",
            "maintenance_currency": "properties_maintenance_currency",
            "version": "license_version",
            "license_expiration": "properties_license_expiration",
            // "license_expiration": "maintenance_expiration",
            "maintenance_expiration": "properties_maintenance_expiration",

            // name="properties,operating_system"
            // "operating_system":


            // "procured_by": "properties_procured_by"
        };


        function formatDateForInput(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return null; // Invalid date
            return date.toISOString().split("T")[0]; // Extract YYYY-MM-DD
        }

        function populateFieldValues(data, mapping) {
            Object.entries(mapping).forEach(([key, fieldId]) => {
                const keys = key.split(".");
                let value = data;

                // Drill down into nested objects
                keys.forEach(k => {
                    if (value && value[k] !== undefined) {
                        value = value[k];
                    } else {
                        value = null;
                    }
                });

                if (value !== null && value !== undefined) {
                    const inputField = $(`#${fieldId}`);

                    console.log("inputField", inputField, value, fieldId)

                    if (inputField.length) {
                        if (inputField.is("select") || inputField.is("input[type='text']") || inputField.is("textarea")) {

                            console.log("inputField2", inputField, value, fieldId)

                            inputField.val(value);
                        } else if (inputField.is("input[type='date']")) {
                            // Format the date for date inputs
                            inputField.val(formatDateForInput(value));
                        } else if (inputField.is(":checkbox")) {
                            inputField.prop("checked", !!value);
                        } else if (inputField.is(":radio")) {
                            $(`input[name="${fieldId}"][value="${value}"]`).prop("checked", true);
                        }
                    }
                }
            });
        }

        $("#fetchLicenseBtn").click(function () {
            const licenseId = $("#licenseId").val();
            const modelId = $("#softwareId").val();
            const poolId = $("#poolId").val();

            if (!licenseId) {
                alert("Please enter a license ID.");
                return;
            }

            // FETCH LICENSE
            $.ajax({
                url: `/inventory/${poolId}/models/${modelId}/licenses/${licenseId}`,
                method: "GET",
                headers: {Accept: "application/json"},
                success: function (response) {
                    if (response && response.data) {
                        const data = response.data;

                        // flatten
                        Object.assign(data, data.properties);
                        delete data.properties;


                        // Populate field values
                        populateFieldValues(data, fieldMapping);

                        CONST_IS_CREATE_FORM = false;
                        $("#formTitle").text("Update License");
                        // $("#saveButton").show(); // Ensure save button is visible after fetching data // Ensure save button is visible

                        // software
                        var swValue = data.product.name;
                        var swId = data.product.model_id;
                        var newOption = new Option(swValue, swId, true, true);
                        $("#mySoftware").append(newOption).trigger('change');
                        $("#myOldSoftware").val(swId)

                        // supplier
                        if (data.supplier != undefined) {
                            var supplierName = data.supplier.name;
                            var supplierId = data.supplier.supplier_id;
                            var newOption = new Option(supplierName, supplierId, true, true);
                            $("#mySupplier").append(newOption).trigger('change');
                        }

                        if (data.is_borrowable) {
                            $("[name=is_borrowable][value=true]").prop("checked", true)
                        } else {
                            $("[name=is_borrowable][value=false]").prop("checked", true)
                        }


                        if (data.reference == "invoice") {
                            $("[name='properties,reference'][value=invoice]").prop("checked", true)
                        } else {
                            $("[name='properties,reference'][value=investment]").prop("checked", true)
                        }


                        ["windows", "linux", "mac_os_x", "ios"].forEach(os => {
                            if (data.operating_system != undefined && data.operating_system.includes(os)) {
                                $(`[name='properties,operating_system'][value=${os}]`).prop("checked", true)
                            } else {
                                $(`[name='properties,operating_system'][value=${os}]`).prop("checked", false)
                            }
                        })

                        const installationList = data.installation || []; // Default to an empty array
                        ["citrix", "local", "web"].forEach(os => {
                            if (installationList.includes(os)) {
                                $(`[name='properties,installation'][value=${os}]`).prop("checked", true);
                            } else {
                                $(`[name='properties,installation'][value=${os}]`).prop("checked", false);
                            }
                        });

                        const quantity_allocations = data.quantity_allocations || []; // Default to an empty array
                        $('#propertiesList').empty()
                        quantity_allocations.forEach(entry => {
                            addQuantityAllocationElement(entry.quantity, entry.room); // Pass parameters to pre-fill the fields
                        });

                        const attachments = data.attachments || []; // Default to an empty array
                        $("#attachmentsList").empty();
                        attachments.forEach(attachment => {

                            let entry = $("#attachmentsList").append(`
                                    <div class="file-item" withData>
                                        <span>${attachment.filename} (${attachment.content_type})</span>
                                        <button type="button" class="remove-attachment-btn" data-attachment-id="${attachment.id}" >Remove</button>
                                    </div>
                                `);

                            entry.data("raw", attachment)
                        });

                        setupDongleAndRetiredHandler(data)

                        $("#saveButton").text("Update License");
                        $("#saveButton").off('click').click(function (e) {

                            // UPDATE LICENSE

                            e.preventDefault(); // Prevent default form submission
                            console.log("Update button clicked");

                            const poolId = $("#poolId").val();
                            const modelId = $("#softwareId").val();
                            const licenseId = $("#licenseId").val();
                            let formData = new FormData($("#softwareForm")[0]);


                            renameFormDataKey(formData, "mySoftware", "model_id");
                            renameFormDataKey(formData, "myOldSoftware", "old_model_id");
                            renameFormDataKey(formData, "mySupplier", "supplier_id");
                            renameFormDataKey(formData, "myOwner", "owner_id");
                            renameFormDataKey(formData, "myResponsibleDepartment", "inventory_pool_id");


                            console.log(">o> ")

                            // set new model_id if needed
                            let model_id = formData.get('model_id')
                            let old_model_id = formData.get('old_model_id')
                            if (model_id != old_model_id) {
                                console.log("model_id != old_model_id")
                                formData.delete('old_model_id')
                                formData.delete('model_id')
                                formData.append('model_id', model_id)
                            } else {
                                console.log("model_id == old_model_id")
                                formData.delete('old_model_id')
                                formData.delete('model_id')
                            }


                            for (let [key, value] of formData.entries()) {
                                console.log(key, value);
                            }

                            checkFormDataOrThrow(formData, modelId)

                            formData.delete('attachments-to-delete');
                            var attachmentsToDelete = $(`#attachmentsList`).data('to-delete') || []
                            formData.append('attachments-to-delete', JSON.stringify(attachmentsToDelete));


                            formData = appendQuantityAllocationToFormData(formData);
                            deleteParamsFromPutPostFormData(formData);

                            // If it's in update mode, make a PUT request
                            $.ajax({
                                url: `/inventory/${poolId}/models/${modelId}/licenses/${licenseId}`,
                                method: "PUT",
                                data: formData,
                                processData: false,
                                contentType: false,
                                headers: {Accept: "application/json"},
                                success: function (response) {
                                    console.log("License updated successfully!", response);

                                    $(`#attachmentsList`).data('to-delete', [])
                                    $('#attachments').val('');

                                    // $('#softwareId').val(response.data.model_id)
                                    // $('#licenseId').val(response.data.id)
                                    $('#softwareId').val(response[0].model_id)
                                    $('#licenseId').val(response[0].id)

                                    $('#fetchLicenseBtn').trigger('click');

                                    showResultEffect("save-success");
                                },
                                error: function (xhr, status, error) {
                                    console.error("Error updating license:", error);
                                    showResultEffect("save-failed");
                                },
                            });
                        });


                        console.log("License data fetched successfully!", response);
                        showResultEffect("save-success");
                    } else {
                        showResultEffect("no-result-success");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching license:", error);
                    showResultEffect("save-failed");
                },
            });
        });
    });

    $("body").ready(function () {
        const licenseId = $("#softwareId").val();
        const poolId = $("#poolId").val();

        if (!licenseId) {
            alert("Please enter a license ID.");
            return;
        }

        $.ajax({
            url: `/inventory/${poolId}/license`,
            method: "GET",
            headers: {Accept: "application/json"},
            success: function (response) {
                if (response && response.fields) {
                    // if (response && response.data) {
                    const data = response.data;
                    const fields = response.fields;

                    initResponsibleData(data);
                    initOwnersData(data);

                    // Generate fields dynamically
                    generateFormFields(fields, "#softwareForm");

                    // debugger
                    $('#inventory_code').val(data.inventory_code)
                    // $('#myOwner').val(data.inventory_pool_id)

                    $("#saveButton").text("Save License");
                    $("#saveButton").off('click').click(function (e) {
                        e.preventDefault(); // Prevent default form submission
                        console.log("Update button clicked");

                        const poolId = $("#poolId").val();
                        // const modelId = $("#softwareId").val();
                        let formData = new FormData($("#softwareForm")[0]);


                        // renameFormDataKey(formData, "mySoftware", "software_id");
                        renameFormDataKey(formData, "mySoftware", "model_id");
                        renameFormDataKey(formData, "mySupplier", "supplier_id");
                        renameFormDataKey(formData, "myOwner", "owner_id");
                        renameFormDataKey(formData, "myResponsibleDepartment", "inventory_pool_id");

                        // for (let [key, value] of formData.entries()) {
                        //     console.log(key, value);
                        // }

                        formData = appendQuantityAllocationToFormData(formData);
                        let modelId = formData.get("model_id")

                        deleteParamsFromPutPostFormData(formData);
                        checkFormDataOrThrow(formData, modelId)

                        // // Debugging: log all keys and values in the FormData
                        // for (let [key, value] of formData.entries()) {
                        //     console.log(key, value);
                        // }

                        // If it's in update mode, make a PUT request
                        $.ajax({
                            // url: `/inventory/${poolId}/license`,
                            url: `/inventory/${poolId}/models/${modelId}/licenses`,
                            method: "POST",
                            data: formData,
                            processData: false,
                            contentType: false,
                            headers: {Accept: "application/json"},
                            success: function (response) {
                                console.log("License create successfully!", response);
                                console.info("UPDATING ITEM-ID")

                                $('#softwareId').val(response.data.model_id)
                                $('#licenseId').val(response.data.item_id)

                                $(`#attachmentsList`).data('to-delete', [])
                                $('#attachments').val('');


                                $('#fetchLicenseBtn').trigger('click');

                                showResultEffect("save-success");


                                // TODO: fetch data by response id's
                            },
                            error: function (xhr, status, error) {
                                console.error("Error updating license:", error);
                                showResultEffect("save-failed");
                            },
                        });
                    });


                    // Populate field values
                    // populateFieldValues(data, fieldMapping);

                    // CONST_IS_CREATE_FORM = false;
                    // $("#formTitle").text("Update License");

                    setupDongleAndRetiredHandler()

                    console.log("License fields fetched successfully!", response);
                    // showResultEffect("save-success");
                } else {
                    showResultEffect("no-result-success");
                }
            },
            error: function (xhr, status, error) {
                console.error("Error fetching license:", error);
                showResultEffect("save-failed");
            },
        });
    });

</script>
</body>
</html>
